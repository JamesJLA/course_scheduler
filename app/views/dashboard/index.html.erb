<div class="row">
  <div class="col-12">
    <h1 class="mb-4">Dashboard</h1>
    <div class="user-info d-flex align-items-center gap-3 mb-4">
      <span class="text-light"><%= current_user.email %></span>
      <%= link_to "Search Users", users_path, class: "btn btn-outline-light" %>
      <%= button_to "Sign Out", destroy_user_session_path, method: :delete, class: "btn btn-outline-light" %>
    </div>
  </div>
</div>

  <div class="dashboard-content">
    <section class="my-enrollments">
      <h2 class="mb-4">My Enrolled Courses</h2>
      <% if @enrollments.any? %>
        <div class="row">
          <% @enrollments.each do |enrollment| %>
            <div class="col-md-6 mb-3">
              <div class="card bg-dark text-light border-secondary" data-enrollment-id="<%= enrollment.id %>">
                <div class="card-body">
                  <h5 class="card-title"><%= enrollment.course.name %></h5>
                  <p class="card-text">
                    <small class="text-muted"><%= enrollment.course.code %></small><br>
                    <%= enrollment.course.credits %> credits | <%= enrollment.course.semester %><br>
                    <small>Status: <%= enrollment.status %></small>
                  </p>
                  <% if enrollment.course.description.present? %>
                    <p class="card-text small"><%= enrollment.course.description %></p>
                  <% end %>
                  <%= button_to "Drop Course", enrollment_path(enrollment), method: :delete, class: "btn btn-danger btn-sm drop-button", data: { turbo_confirm: "Are you sure you want to drop this course?" } %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-info">You are not enrolled in any courses yet.</div>
      <% end %>
    </section>

    <section class="available-courses">
      <h2>Available Courses</h2>
      
      <div class="card bg-dark text-light border-secondary mb-4">
        <div class="card-body">
          <h5 class="card-title">Can't find your course?</h5>
          <button id="toggle-custom-course-form" class="btn btn-outline-success">Add Custom Course</button>
          
          <div id="custom-course-form" class="mt-3" style="display: none;">
            <h6 class="mb-3">Create Custom Course</h6>
            <%= form_with url: enrollments_path, method: :post, local: true, html: { id: "custom-course-enroll-form" } do |form| %>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= label_tag "custom_course_name", "Course Name", class: "form-label text-light" %>
                  <%= text_field_tag "enrollment[custom_course][name]", nil, required: true, class: "form-control bg-secondary text-light border-secondary" %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= label_tag "custom_course_code", "Course Code", class: "form-label text-light" %>
                  <%= text_field_tag "enrollment[custom_course][code]", nil, required: true, class: "form-control bg-secondary text-light border-secondary" %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= label_tag "custom_course_credits", "Credits", class: "form-label text-light" %>
                  <%= number_field_tag "enrollment[custom_course][credits]", nil, min: 1, max: 10, required: true, class: "form-control bg-secondary text-light border-secondary" %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= label_tag "custom_course_semester", "Semester", class: "form-label text-light" %>
                  <%= text_field_tag "enrollment[custom_course][semester]", nil, required: true, class: "form-control bg-secondary text-light border-secondary" %>
                </div>
                <div class="col-12 mb-3">
                  <%= label_tag "custom_course_description", "Description", class: "form-label text-light" %>
                  <%= text_area_tag "enrollment[custom_course][description]", nil, rows: 3, class: "form-control bg-secondary text-light border-secondary" %>
                </div>
              </div>
              <div class="d-flex gap-2 justify-content-end">
                <%= form.submit "Create & Enroll", class: "btn btn-success" %>
                <button type="button" id="cancel-custom-course" class="btn btn-outline-secondary">Cancel</button>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="row">
        <% @courses.each do |course| %>
          <% enrolled = @enrollments.any? { |e| e.course_id == course.id } %>
          <div class="col-md-6 mb-3">
            <div class="card bg-dark text-light border-secondary <%= 'border-success' if enrolled %>">
              <div class="card-body">
                <h5 class="card-title"><%= course.name %></h5>
                <p class="card-text">
                  <small class="text-muted"><%= course.code %></small><br>
                  <%= course.credits %> credits | <%= course.semester %>
                </p>
                <% if course.description.present? %>
                  <p class="card-text small"><%= course.description %></p>
                <% end %>
                <% unless enrolled %>
                  <%= button_to "Enroll", enrollments_path, method: :post, params: { enrollment: { course_id: course.id } }, class: "btn btn-success btn-sm enroll-button" %>
                <% else %>
                  <span class="badge bg-success">Enrolled</span>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </section>
  </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
  const toggleButton = document.getElementById('toggle-custom-course-form');
  const cancelButton = document.getElementById('cancel-custom-course');
  const form = document.getElementById('custom-course-form');
  
  // Toggle custom course form
  if (toggleButton && form) {
    toggleButton.addEventListener('click', function() {
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      toggleButton.textContent = form.style.display === 'none' ? 'Add Custom Course' : 'Hide Form';
    });
    
    if (cancelButton) {
      cancelButton.addEventListener('click', function() {
        form.style.display = 'none';
        toggleButton.textContent = 'Add Custom Course';
      });
    }
  }
  
  // Handle custom course form submission with AJAX
  const formElement = document.getElementById('custom-course-enroll-form');
  if (formElement) {
    formElement.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(formElement);
      const submitButton = formElement.querySelector('input[type="submit"]');
      const originalText = submitButton.value;
      submitButton.value = 'Creating...';
      submitButton.disabled = true;
      
      fetch(formElement.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Turbo.visit(window.location.href, { action: 'replace' });
        } else {
          alert('Error: ' + data.errors.join(', '));
          this.innerHTML = originalText;
          this.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the course');
        submitButton.value = originalText;
        submitButton.disabled = false;
      });
    });
  }
  
  // Handle regular enrollment buttons with AJAX
  const enrollButtons = document.querySelectorAll('.enroll-button');
  enrollButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      const form = this.closest('form');
      const formData = new FormData(form);
      const originalText = this.innerHTML;
      this.innerHTML = 'Enrolling...';
      this.disabled = true;
      
      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Error: ' + data.errors.join(', '));
          this.innerHTML = originalText;
          this.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while enrolling in course');
        this.innerHTML = originalText;
        this.disabled = false;
      });
    });
  });
  
  // Handle drop course buttons with AJAX
  const dropButtons = document.querySelectorAll('.drop-button');
  dropButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (!confirm('Are you sure you want to drop this course?')) {
        return;
      }
      
      const form = this.closest('form');
      const formData = new FormData(form);
      const originalText = this.innerHTML;
      this.innerHTML = 'Dropping...';
      this.disabled = true;
      
      fetch(form.action, {
        method: 'DELETE',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Error: ' + data.errors.join(', '));
          this.innerHTML = originalText;
          this.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while dropping course');
        this.innerHTML = originalText;
        this.disabled = false;
      });
    });
  });
});
</script>
